name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ— Setup repo
      uses: actions/checkout@v4

    - name: ğŸ— Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: bun

    - name: ğŸ— Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: ğŸ— Setup EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        packager: bun
        token: ${{ secrets.EXPO_TOKEN }}

    - name: ğŸ“¦ Install dependencies
      run: bun install

    - name: ğŸ—„ï¸ Generate database schema
      run: bun run db:generate

    - name: âœ¨ Code formatting check
      run: bun run format

    - name: ğŸ” Check Expo dependencies
      run: bun run expo-check

    - name: ğŸ› ï¸ Build Android APK
      run: eas build --platform android --profile preview --non-interactive

    - name: ğŸ“± Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: capsula-android-apk
        path: "*.apk"
        retention-days: 30

    - name: ğŸ“‹ Build summary
      run: |
        echo "âœ… Capsula Android build completed successfully!"
        echo "ğŸ“± APK artifact uploaded for download"
        echo "ğŸ”§ Install with: adb install capsula.apk"